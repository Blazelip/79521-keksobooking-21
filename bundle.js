(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,t=e=>{const t=e.slice();for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[o],t[o]=n}return t};window.util={getRandomInteger:e,getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],shuffleArray:t,getRandomArray:o=>t(o).slice(e(0,o.length-1)),addIdToSourceData:e=>e.map(((e,t)=>(e.offer.id=t,e))),debounce:(e,t=500)=>{let o=null;return(...n)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...n)}),t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o)=>{e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} - ${e.statusText}`)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4};window.backend={getData:(o,n)=>{const r=new XMLHttpRequest;r.responseType="json",t(r,o,n),r.open("GET",e+"/data"),r.send()},sendData:(o,n,r)=>{const a=new XMLHttpRequest;a.responseType="json",t(a,n,r),a.open("POST",e),a.send(o)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success");window.statusMsg={showError:o=>{const n=t.cloneNode(!0);n.querySelector(".error__message").textContent=""+o,e.appendChild(n);const r=()=>{n.remove(),document.removeEventListener("keydown",a)},a=e=>{"Escape"===e.key&&r()};document.addEventListener("keydown",a),n.addEventListener("click",(()=>{r()}))},showSuccess:()=>{const t=o.cloneNode(!0);e.appendChild(t);const n=e=>{"Escape"!==e.key&&0!==e.button||t.remove(),document.removeEventListener("keydown",n)};document.addEventListener("keydown",n),t.addEventListener("click",n)}}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=t.querySelector(".map__filters-container"),n=document.querySelector("#card").content.querySelector(".map__card"),r=e=>{"Escape"!==e.key&&0!==e.button||(a(),window.pin.removeActiveClass())},a=()=>{const e=t.querySelector(".map__card");e&&(document.removeEventListener("keydown",r),e.remove())};window.card={show:s=>{a();const i=(t=>{const{offer:o,author:r}=t,{title:a,address:s,price:i,type:d,rooms:c,guests:l,checkin:u,checkout:p,description:m,features:y,photos:w}=o,{avatar:f}=r,v=n.cloneNode(!0),_=v.querySelector(".popup__avatar");return v.querySelector(".popup__title").textContent=a,v.querySelector(".popup__text--address").textContent=s,v.querySelector(".popup__text--price").textContent=i+"₽/ночь",v.querySelector(".popup__type").textContent=e[d],v.querySelector(".popup__text--capacity").textContent=`${c} комнаты для ${l} гостей`,v.querySelector(".popup__text--time").textContent=`Заезд после ${u}, выезд до ${p}.`,v.querySelector(".popup__description").textContent=m,f?_.src=f:v.removeChild(_),((e,t)=>{const o=t.querySelector(".popup__features");o.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),o.appendChild(t)}))})(y,v),((e,t)=>{const o=t.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");o.innerHTML="",e.forEach((e=>{const t=n.cloneNode(!0);t.src=""+e,o.appendChild(t)}))})(w,v),(e=>{const t=e.children,o=Array.from(t).filter((e=>"IMG"!==e.tagName));for(let t of o)""===t.innerHTML&&""===t.textContent&&e.removeChild(t)})(v),v})(s),d=i.querySelector(".popup__close");t.insertBefore(i,o),document.addEventListener("keydown",r),d.addEventListener("click",r)},closeCurrent:a}})(),(()=>{const e=-32.5,t=1167.5,o=43,n=543,r=document.querySelector(".map__pin--main"),a=document.querySelector(".map__pins"),s=document.querySelector("#address"),i=document.querySelector("#pin").content.querySelector(".map__pin"),d=e=>{if(""===e.offer)return null;const t=i.cloneNode(!0),o=t.querySelector("img");return t.dataset.id=""+e.offer.id,t.style.left=e.location.x-25+"px",t.style.top=e.location.y-70+"px",o.src=e.author.avatar,o.alt=e.offer.title,t},c=()=>{a.querySelectorAll(".map__pin--active").forEach((e=>{e.classList.remove("map__pin--active")}))};window.pin={resetMain:()=>{r.style.left="570px",r.style.top="374px"},make:d,render:e=>{const t=document.createDocumentFragment();e.forEach((e=>{const o=d(e);o&&t.appendChild(o)})),a.appendChild(t)},onClick:e=>{const t=e.target;if(("IMG"===t.tagName||t.classList.contains("map__pin"))&&!t.classList.contains("map__pin--main")&&!t.closest(".map__pin--main")){const o=parseInt(t.dataset.id,10)||parseInt(e.target.closest(".map__pin").dataset.id,10),n=window.dataWithId.find((e=>e.offer.id===o));n&&(c(),t.closest(".map__pin").classList.add("map__pin--active"),window.card.show(n))}},onMainMove:a=>{a.preventDefault();let i={x:a.clientX,y:a.clientY};const d=a=>{a.preventDefault();const d=i.x-a.clientX,c=i.y-a.clientY;i={x:a.clientX,y:a.clientY};const l={x:r.offsetLeft-d,y:r.offsetTop-c};l.x>=t&&(l.x=t+"px"),l.x<=e&&(l.x=e+"px"),l.y>n&&(l.y=n+"px"),l.y<o&&(l.y=o+"px"),r.style.left=l.x+"px",r.style.top=l.y+"px",s.value=window.form.calcPinAddress(!0)},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},delete:()=>{a.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},removeActiveClass:c}})(),(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t=document.querySelector(".ad-form"),o=t.querySelector("#title"),n=t.querySelector("#room_number"),r=t.querySelector("#capacity"),a=t.querySelector("#price"),s=t.querySelector("#type"),i=t.querySelector(".ad-form__element--time"),d=t.querySelector("#timein"),c=t.querySelector("#timeout"),l=()=>{const e=parseInt(n.value,10),t=parseInt(r.value,10);n.setCustomValidity(""),r.setCustomValidity(""),100===e&&0!==t?r.setCustomValidity('100 комнат, это шо, дворец по-твоему? Выбирай "Не для гостей"'):0===t&&100!==e?r.setCustomValidity("Не для гостей подходит только 100 комнат, бро"):e<t?r.setCustomValidity("Количество комнат не должно быть меньше числа персон"):r.setCustomValidity(""),r.reportValidity()},u=()=>{const t=e[s.value];a.min=""+t,a.placeholder=""+t};o.addEventListener("change",(()=>{const e=o.value.trim().length;e<30?o.setCustomValidity("Заголовок должен быть не менее 30 символов"):e>100?o.setCustomValidity("Заголовок не должен превышать 100 символов"):o.setCustomValidity(""),o.reportValidity()})),a.addEventListener("change",(()=>{const t=e[s.value];a.value<t?a.setCustomValidity(`Минимальная цена за ночь ${t} руб. Нужно увеличить цену.`):a.value>1e6?a.setCustomValidity("Максимальная цена за ночь 1000000 руб. Нужно уменьшить цену."):a.setCustomValidity(""),a.reportValidity()})),n.addEventListener("change",l),r.addEventListener("change",l),s.addEventListener("change",(()=>{u()})),i.addEventListener("change",(e=>{d.value=e.target.value,c.value=e.target.value})),window.validation={setMinPrice:u,onRoomsChange:l}})(),(()=>{const e=["jpg","jpeg","png"],t="img/muffin-grey.svg",o=document.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),r=n.querySelector(".ad-form__reset"),a=n.querySelectorAll("fieldset"),s=document.querySelector(".map__filters"),i=s.querySelectorAll(".map__filter, .map__features"),d=n.querySelector("#address"),c=n.querySelector(".ad-form-header__input"),l=n.querySelector(".ad-form-header__preview img"),u=n.querySelector(".ad-form__input"),p=n.querySelector(".ad-form__photo"),m=t=>{const o=t.target,n=o.files[0],r=n.type;if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.classList.contains("ad-form-header__input")?l.src=e.result:p.innerHTML=`<img class="ad-form__photo-preview" src="${e.result}">`})),e.readAsDataURL(n)}},y=(e,t)=>{for(let o of e)o.disabled=t},w=e=>`${Math.round(parseInt(o.style.left,10)+32.5)}, ${e?Math.round(parseInt(o.style.top,10)+65+22):Math.round(parseInt(o.style.top,10)+32.5)}`,f=()=>{window.card.closeCurrent(),window.pin.delete(),s.reset(),n.reset(),l.src=t,p.innerHTML="",window.pin.resetMain(),window.main.deactivateApp(),window.statusMsg.showSuccess()},v=e=>{window.statusMsg.showError(e)},_=()=>{window.card.closeCurrent(),window.pin.delete(),s.reset(),n.reset(),l.src=t,p.innerHTML="",window.pin.resetMain(),window.main.deactivateApp()};c.addEventListener("change",m),u.addEventListener("change",m),n.addEventListener("submit",(e=>{e.preventDefault(),window.validation.onRoomsChange(),n.checkValidity()&&window.backend.sendData(new FormData(n),f,v)})),window.form={calcPinAddress:w,disable:()=>{n.classList.add("ad-form--disabled"),y(a,!0),y(i,!0),d.value=w(!1),window.validation.setMinPrice(),r.removeEventListener("click",_)},enable:()=>{n.classList.remove("ad-form--disabled"),y(a,!1),y(i,!1),d.value=w(!0),r.addEventListener("click",_)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__pins"),n=e=>{window.dataWithId=window.util.addIdToSourceData(e),window.pin.render(window.filter.getData(window.dataWithId))},r=e=>{window.statusMsg.showError(e)},a=e=>{0!==e.button&&"Enter"!==e.key||s()},s=()=>{e.classList.remove("map--faded"),window.backend.getData(n,r),window.form.enable(),t.removeEventListener("mousedown",a),t.removeEventListener("keydown",a),o.addEventListener("click",window.pin.onClick)},i=()=>{e.classList.add("map--faded"),window.form.disable(),t.addEventListener("mousedown",window.pin.onMainMove),t.addEventListener("mousedown",a),t.addEventListener("keydown",a),o.removeEventListener("click",window.pin.onClick)};i(),window.main={deactivateApp:i}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),s=1e4,i=5e4,d=1e4,c=5e4,l=t=>{const n=o.value;return t.offer.type===n||n===e},u=t=>{switch(n.value){case e:return!0;case"middle":if(t.offer.price>=s&&t.offer.price<=i)return!0;break;case"low":if(t.offer.price<d)return!0;break;case"high":if(t.offer.price>c)return!0}return!1},p=t=>{const o=r.value;return t.offer.rooms===parseInt(o,10)||o===e},m=t=>{const o=a.value;return t.offer.guests===parseInt(o,10)||o===e},y=e=>Array.from(t.querySelectorAll(".map__checkbox:checked")).every((t=>e.offer.features.includes(t.value))),w=e=>{const t=[];for(let o=0;o<e.length&&t.length<5;o++)l(e[o])&&u(e[o])&&p(e[o])&&m(e[o])&&y(e[o])&&t.push(e[o]);return t};t.addEventListener("change",window.util.debounce((()=>{window.card.closeCurrent(),window.pin.delete(),window.pin.render(w(window.dataWithId))}))),window.filter={getData:w}})()})();