(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,t=e=>{const t=e.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1)),o=t[e];t[e]=t[n],t[n]=o}return t};window.util={getRandomInteger:e,getRandomArrayElement:e=>e[Math.floor(Math.random()*e.length)],shuffleArray:t,getRandomArray:n=>t(n).slice(e(0,n.length-1)),addIdToSourceData:e=>e.map(((e,t)=>(e.offer.id=t,e))),debounce:(e,t=500)=>{let n=null;return(...o)=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>{e(...o)}),t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/",t=(e,t,n)=>{e.addEventListener("load",(()=>{200===e.status?t(e.response):n(`Статус ответа: ${e.status} - ${e.statusText}`)})),e.addEventListener("error",(function(){n("Произошла ошибка соединения")})),e.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4};window.backend={getData:(n,o)=>{const r=new XMLHttpRequest;r.responseType="json",t(r,n,o),r.open("GET",e+"data"),r.send()},sendData:(n,o,r)=>{const a=new XMLHttpRequest;a.responseType="json",t(a,o,r),a.open("POST",e),a.send(n)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.getElementById("error").content.querySelector(".error"),n=document.getElementById("success").content.querySelector(".success");window.statusMsg={showErrorMsg:n=>{const o=t.cloneNode(!0);o.querySelector(".error__message").textContent=""+n,e.appendChild(o);const r=()=>{o.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",a)},a=()=>{r()},i=e=>{"Escape"===e.key&&r()};document.addEventListener("keydown",i),document.addEventListener("click",a)},showSuccessMsg:()=>{const t=n.cloneNode(!0);e.appendChild(t);const o=e=>{"Escape"!==e.key&&0!==e.button||t.remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",o)};document.addEventListener("keydown",o),document.addEventListener("click",o)}}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),n=t.querySelector(".map__filters-container"),o=document.getElementById("card").content.querySelector(".map__card"),r=t=>{const{offer:n,author:r}=t,{title:a,address:i,price:s,type:d,rooms:c,guests:l,checkin:u,checkout:p,description:m,features:y,photos:w}=n,{avatar:f}=r,v=o.cloneNode(!0),_=v.querySelector(".popup__avatar");return v.querySelector(".popup__title").textContent=a,v.querySelector(".popup__text--address").textContent=i,v.querySelector(".popup__text--price").textContent=s+"₽/ночь",v.querySelector(".popup__type").textContent=e[d],v.querySelector(".popup__text--capacity").textContent=`${c} комнаты для ${l} гостей`,v.querySelector(".popup__text--time").textContent=`Заезд после ${u}, выезд до ${p}.`,v.querySelector(".popup__description").textContent=m,f?_.src=f:v.removeChild(_),((e,t)=>{const n=t.querySelector(".popup__features");n.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),n.appendChild(t)}))})(y,v),((e,t)=>{const n=t.querySelector(".popup__photos"),o=n.querySelector(".popup__photo");n.innerHTML="",e.forEach((e=>{const t=o.cloneNode(!0);t.src=""+e,n.appendChild(t)}))})(w,v),(e=>{const t=e.children,n=Array.from(t).filter((e=>"IMG"!==e.tagName));for(let t of n)""===t.innerHTML&&""===t.textContent&&e.removeChild(t)})(v),v},a=e=>{"Escape"!==e.key&&0!==e.button||i()},i=()=>{const e=t.querySelector(".map__card");e&&(document.removeEventListener("keydown",a),e.remove())};window.card={makeCard:r,showCard:e=>{i();const o=r(e),s=o.querySelector(".popup__close");t.insertBefore(o,n),document.addEventListener("keydown",a),s.addEventListener("click",a)},closeCurrentCard:i}})(),(()=>{const e=-32.5,t=1167.5,n=43,o=543,r=document.querySelector(".map__pin--main"),a=document.querySelector(".map__pins"),i=document.querySelector("#address"),s=document.getElementById("pin").content.querySelector(".map__pin"),d=e=>{const t=s.cloneNode(!0),n=t.querySelector("img");return t.dataset.id=""+e.offer.id,t.style.left=e.location.x-25+"px",t.style.top=e.location.y-70+"px",n.src=e.author.avatar,n.alt=e.offer.title,t};window.pin={resetMainPinCoord:()=>{r.style.left="570px",r.style.top="374px"},makePin:d,renderPins:e=>{const t=document.createDocumentFragment();e.forEach((e=>{const n=d(e);t.appendChild(n)})),a.appendChild(t)},onPinClick:e=>{const t=e.target;if(("IMG"===t.tagName||t.classList.contains("map__pin"))&&!t.classList.contains("map__pin--main")&&!t.closest(".map__pin--main")){const n=parseInt(t.dataset.id,10)||parseInt(e.target.closest(".map__pin").dataset.id,10),o=window.dataWithId.find((e=>e.offer.id===n));o&&window.card.showCard(o)}},moveMainPin:a=>{a.preventDefault();let s={x:a.clientX,y:a.clientY};const d=a=>{a.preventDefault();const d=s.x-a.clientX,c=s.y-a.clientY;s={x:a.clientX,y:a.clientY};const l={x:r.offsetLeft-d,y:r.offsetTop-c};l.x>=t&&(l.x=t+"px"),l.x<=e&&(l.x=e+"px"),l.y>o&&(l.y=o+"px"),l.y<n&&(l.y=n+"px"),r.style.left=l.x+"px",r.style.top=l.y+"px",i.value=window.form.calcPinAddress(!0)},c=function(e){e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},deletePins:()=>{a.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t=document.querySelector(".ad-form"),n=t.querySelector("#title"),o=t.querySelector("#room_number"),r=t.querySelector("#capacity"),a=t.querySelector("#price"),i=t.querySelector("#type"),s=t.querySelector(".ad-form__element--time"),d=t.querySelector("#timein"),c=t.querySelector("#timeout"),l=()=>{const t=e[i.value];a.min=""+t,a.placeholder=""+t};n.addEventListener("change",(()=>{const e=n.value.trim().length;e<30?n.setCustomValidity("Заголовок должен быть не менее 30 символов"):e>100?n.setCustomValidity("Заголовок не должен превышать 100 символов"):n.setCustomValidity(""),n.reportValidity()})),a.addEventListener("change",(()=>{const t=e[i.value];a.value<t?a.setCustomValidity(`Минимальная цена за ночь ${t} руб. Нужно увеличить цену.`):a.value>1e6?a.setCustomValidity("Максимальная цена за ночь 1000000 руб. Нужно уменьшить цену."):a.setCustomValidity(""),a.reportValidity()})),i.addEventListener("change",(()=>{l()})),s.addEventListener("change",(e=>{d.value=e.target.value,c.value=e.target.value})),window.validation={setMinPrice:l,roomsFieldChecker:()=>{const e=parseInt(o.value,10),t=parseInt(r.value,10);o.setCustomValidity(""),r.setCustomValidity(""),100===e&&0!==t?r.setCustomValidity('100 комнат, это шо, дворец по-твоему? Выбирай "Не для гостей"'):0===t&&100!==e?r.setCustomValidity("Не для гостей подходит только 100 комнат, бро"):e<t?r.setCustomValidity("Количество комнат не должно быть меньше числа персон"):r.setCustomValidity(""),r.reportValidity()}}})(),(()=>{const e=["jpg","jpeg","png"],t="/img/muffin-grey.svg",n=document.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=o.querySelector(".ad-form__reset"),a=o.querySelectorAll("fieldset"),i=document.querySelector(".map__filters"),s=i.querySelectorAll(".map__filter, .map__features"),d=o.querySelector("#address"),c=o.querySelector(".ad-form-header__input"),l=o.querySelector(".ad-form-header__preview img"),u=o.querySelector(".ad-form__input"),p=o.querySelector(".ad-form__photo"),m=t=>{const n=t.target,o=n.files[0],r=o.type;if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(()=>{n.classList.contains("ad-form-header__input")?l.src=e.result:p.innerHTML=`<img class="ad-form__photo-preview" src="${e.result}">`})),e.readAsDataURL(o)}},y=(e,t)=>{for(let n of e)n.disabled=t},w=e=>`${Math.round(parseInt(n.style.left,10)+32.5)}, ${e?Math.round(parseInt(n.style.top,10)+65+22):Math.round(parseInt(n.style.top,10)+32.5)}`,f=()=>{window.card.closeCurrentCard(),window.pin.deletePins(),i.reset(),o.reset(),l.src=t,p.innerHTML="",window.pin.resetMainPinCoord(),window.main.deactivateApp(),window.statusMsg.showSuccessMsg()},v=e=>{window.statusMsg.showErrorMsg(e)},_=()=>{window.card.closeCurrentCard(),window.pin.deletePins(),i.reset(),o.reset(),l.src=t,p.innerHTML="",window.pin.resetMainPinCoord(),window.main.deactivateApp()};c.addEventListener("change",m),u.addEventListener("change",m),o.addEventListener("submit",(e=>{e.preventDefault(),window.validation.roomsFieldChecker(),o.checkValidity()&&window.backend.sendData(new FormData(o),f,v)})),window.form={calcPinAddress:w,disableForm:()=>{o.classList.add("ad-form--disabled"),y(a,!0),y(s,!0),d.value=w(!1),window.validation.setMinPrice(),r.removeEventListener("click",_)},enableForm:()=>{o.classList.remove("ad-form--disabled"),y(a,!1),y(s,!1),d.value=w(!0),r.addEventListener("click",_)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),n=document.querySelector(".map__pins"),o=e=>{window.dataWithId=window.util.addIdToSourceData(e),window.pin.renderPins(window.filter.filterData(window.dataWithId))},r=e=>{window.statusMsg.showErrorMsg(e)},a=e=>{0!==e.button&&"Enter"!==e.key||i()},i=()=>{e.classList.remove("map--faded"),window.backend.getData(o,r),window.form.enableForm(),t.removeEventListener("mousedown",a),t.removeEventListener("keydown",a),n.addEventListener("click",window.pin.onPinClick)},s=()=>{e.classList.add("map--faded"),window.form.disableForm(),t.addEventListener("mousedown",window.pin.moveMainPin),t.addEventListener("mousedown",a),t.addEventListener("keydown",a),n.removeEventListener("click",window.pin.onPinClick)};s(),window.main={deactivateApp:s}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),n=t.querySelector("#housing-type"),o=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),i=1e4,s=5e4,d=1e4,c=5e4,l=t=>{const o=n.value;return t.offer.type===o||o===e},u=t=>{switch(o.value){case e:return!0;case"middle":if(t.offer.price>=i&&t.offer.price<=s)return!0;break;case"low":if(t.offer.price<d)return!0;break;case"high":if(t.offer.price>c)return!0}return!1},p=t=>{const n=r.value;return t.offer.rooms===parseInt(n,10)||n===e},m=t=>{const n=a.value;return t.offer.guests===parseInt(n,10)||n===e},y=e=>Array.from(t.querySelectorAll(".map__checkbox:checked")).every((t=>e.offer.features.includes(t.value))),w=e=>{const t=[];for(let n=0;n<e.length&&t.length<5;n++)l(e[n])&&u(e[n])&&p(e[n])&&m(e[n])&&y(e[n])&&t.push(e[n]);return t};t.addEventListener("change",window.util.debounce((()=>{window.card.closeCurrentCard(),window.pin.deletePins(),window.pin.renderPins(w(window.dataWithId))}))),window.filter={filterData:w}})()})();